"use strict";angular.module("gps",["ngRoute","gps.controllers"]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!1),a.when("/",{controller:"MainController"}).when("/node/:node",{templateUrl:"templates/sidebar/node.tpl.html",controller:"NodeController"}).when("/link/:n1/:n2",{templateUrl:"templates/sidebar/link.tpl.html",controller:"LinkController"}).when("/path/:p1/:p2",{templateUrl:"templates/sidebar/path.tpl.html",controller:"PathController"})}]);var app=angular.module("gps.controllers",["leaflet-directive"]);app.controller("HeaderController",["$rootScope","$scope","$location","$http",function(a,b,c,d){b.nodes=[],d.get("/api/node/search").success(function(a){for(var c in a)b.nodes.push(a[c].text)}),b.dropdown=[{text:"Logout",click:"session.logout()"}],b.selectedNode=void 0,b.$watch("selectedNode",function(a){-1!==b.nodes.indexOf(a)&&c.url("/node/"+a)})}]),app.controller("MainController",["$scope","$rootScope",function(a,b){b.gps=!1,a.showingGPS=!1,a.gpsAlert&&a.gpsAlert.hide();for(var c in a.links){var d=a.links[c];d.color=d.activeColor}}]),app.controller("NodeController",["$scope","$routeParams",function(a,b){a.gps=!1,a.showingGPS=!1,a.gpsAlert&&a.gpsAlert.hide(),a.nodesPromise.promise.then(function(c){a.active=c[b.node],a.center={lat:a.active.lat,lng:a.active.lng,zoom:16}}),a.resetActive=function(){a.gps=!1,a.showingGPS=!1,a.gpsAlert&&a.gpsAlert.hide();for(var b in a.links){var c=a.links[b];c.color=c.activeColor}}}]),app.controller("LinkController",["$scope","$routeParams","leafletBoundsHelpers","leafletData",function(a,b,c,d){a.linksPromise.promise.then(function(c){var e=b.n1,f=b.n2;a.active=c[e+"_"+f],a.active||(a.active=c[f+"_"+e]),a.active.color="#FFF";var e=a.nodes[a.active.nodes[0]],f=a.nodes[a.active.nodes[1]];d.getMap().then(function(a){a.fitBounds([[e.lat,e.lng],[f.lat,f.lng]])})}),a.resetActive=function(){a.gps=!1,a.showingGPS=!1,a.gpsAlert&&a.gpsAlert.hide();for(var b in a.links){var c=a.links[b];c.color=c.activeColor}}}]),app.controller("PathController",["$scope","$routeParams","$alert","$http","leafletData",function(a,b,c,d,e){var f=b.p1,g=b.p2;a.active=[],a.gpsAlert&&a.gpsAlert.hide();var h={0:"#491",1:"#FFFF00",2:"#FF8800",3:"#FF0000"};a.resetActive=function(){a.gps=!1,a.gpsAlert&&a.gpsAlert.hide();for(var b in a.links){var c=a.links[b];c.color=c.activeColor}},a.gpsAlert=c({title:"",content:'<img style="margin-right: 1em;" src="/images/loading-spin.svg" /> <strong>Wait.</strong> Getting the route...',placement:"top-right",type:"warning",show:!0});var i=function(b){angular.forEach(a.links,function(a){a===b?(j(),a.color="#FFF"):a.color=h[a.saturation]})},j=function(b){angular.forEach(a.nodes,function(a){a===b?(i(),a.icon.markerColor="red"):a.icon.markerColor="blue"})},k=function(a){var b=[];for(var c in a){var d=a[c];d&&(-1===b.indexOf(d.nodes[0].name)&&b.push(d.nodes[0].name),-1===b.indexOf(d.nodes[1].name)&&b.push(d.nodes[1].name))}return b};i(),d.get("/api/path/"+f+"/"+g).success(function(b){e.getMap().then(function(c){var d=k(b),e=[];for(var f in d){var g=d[f];e.push([a.nodes[g].lat,a.nodes[g].lng])}c.fitBounds(e)}),a.gpsAlert.hide();for(var c in a.links){var d=a.links[c];for(var f in b){var g=b[f];g&&g._id===d.id&&(d.color="#FFF")}}a.active=b,a.gps=!1}).error(function(){a.gps=!1}),a.resetActive=function(){a.gps=!1,a.showingGPS=!1,a.gpsAlert&&a.gpsAlert.hide();for(var b in a.links){var c=a.links[b];c.color=c.activeColor}}}]),app.controller("MapController",["$scope","$http","$timeout","$location","$routeParams","$q","leafletBoundsHelpers",function(a,b,c,d,e,f,g){angular.extend(a,{center:{lat:40.000531,lng:-.039139,zoom:12},nodes:{},linksPromise:f.defer(),nodesPromise:f.defer(),bounds:[],links:{},gps:!1,neighbors:[],layers:{baselayers:{googleHybrid:{name:"Google Hybrid",layerType:"HYBRID",type:"google"},osm:{name:"OpenStreetMap",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",type:"xyz"}}}});var h={0:"#491",1:"#FFFF00",2:"#FF8800",3:"#FF0000"},i=function(b){return{lat:a.nodes[b].lat,lng:a.nodes[b].lng}};a.$on("leafletDirectivePath.mouseout",function(b,c){if(0!==d.path().indexOf("/path")){var c=a.links[c.pathName];a.active&&a.active.name===c.name||(c.color=c.activeColor)}}),a.$on("leafletDirectivePath.mouseover",function(b,c){if(0!==d.path().indexOf("/path")){var c=a.links[c.pathName];c.color="#FFF"}}),a.$on("leafletDirectivePath.click",function(b,c){a.active&&(a.active.color=a.active.activeColor),a.active=a.links[c.pathName],a.active.color="#FFF";var e=a.nodes[a.active.nodes[0]],f=a.nodes[a.active.nodes[1]];a.bounds=g.createBoundsFromArray([[e.lat,e.lng],[f.lat,f.lng]]),d.url("/link/"+c.pathName.replace("_","/"))}),a.$on("leafletDirectiveMarker.click",function(b,c){return a.active&&(a.active.color=a.active.activeColor),a.gps?void j(a.active.name,c.markerName):(a.active=a.nodes[c.markerName],a.center={lat:a.active.lat,lng:a.active.lng,zoom:16},void d.url("/node/"+c.markerName))});var j=function(a,b){d.url("/path/"+a+"/"+b)};a.gpsAlert,a.startGPS=function(){a.gpsAlert=$alert({title:"Choose the desired destination.",content:"Click on the node where you want to go from "+a.active.name+".",placement:"top-right",type:"success",show:!0}),a.gps=!0},b.get("/api/node/").success(function(c){for(var d in c){var e=c[d],f="<strong>"+e.name+" ("+e.ip+")</strong>",g={icon:{type:"awesomeMarker",icon:"star",markerColor:e.alive?"blue":"red",labelAnchor:[10,-24]},label:{message:f,direction:"auto"},riseOnHover:!0,lat:e.lat,lng:e.lng,name:e.name,node:e};a.nodes[e.name]=g}a.nodesPromise.resolve(a.nodes),b.get("/api/link/").success(function(b){angular.forEach(b,function(b){var c=b.nodes[0],d=b.nodes[1],e=i(c.name),g=i(d.name),j=b.bandwidth/5+2;j>10&&(j=10),f='<img style="width: 380px;" src="/graph/bandwidth/'+c.name+"/"+d.name+'">',a.links[c.name+"_"+d.name]={id:b._id,type:"polyline",weight:j,color:h[b.saturation],activeColor:h[b.saturation],saturation:b.saturation,label:{message:f},opacity:.9,name:c.name+"-"+d.name,distance:b.distance,nodes:[b.nodes[0].name,b.nodes[1].name],latlngs:[e,g],link:{n1:c,n2:d}}}),a.linksPromise.resolve(a.links)})})}]);